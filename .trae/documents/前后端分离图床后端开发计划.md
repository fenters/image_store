# 前后端分离图床后端完整开发计划

## 项目概述

这是一个基于FastAPI的前后端分离图床系统，用于存储和展示图片。支持用户注册登录、多Token管理、图片上传/查询/删除，以及Gitee仓库存储功能。

## 技术栈

* **后端框架**: FastAPI 0.100+

* **编程语言**: Python 3.10+

* **数据库**: MySQL 8.0+ (账号: root, 密码: 123456)

* **缓存**: Redis 6.0+

* **ORM**: SQLAlchemy 2.0+

* **数据验证**: Pydantic 2.0+

* **认证**: JWT (PyJWT)

* **文件处理**: python-multipart

* **Gitee API**: gidgethub

* **环境管理**: python-dotenv

## 目录结构

```
backend/
├── src/
│   ├── main.py              # FastAPI应用入口
│   ├── config.py            # 配置管理（环境变量、常量等）
│   ├── database.py          # 数据库连接管理
│   ├── models/              # 数据库模型定义
│   │   ├── __init__.py      # 模型导入
│   │   ├── user.py          # 用户模型
│   │   ├── token.py         # Token模型
│   │   └── image.py         # 图片模型
│   ├── schemas/             # 请求响应模型（Pydantic）
│   │   ├── __init__.py      # Schema导入
│   │   ├── auth.py          # 认证相关Schema
│   │   ├── token.py         # Token相关Schema
│   │   ├── image.py         # 图片相关Schema
│   │   └── common.py        # 通用Schema（响应格式等）
│   ├── routers/             # API路由定义
│   │   ├── __init__.py      # 路由注册
│   │   ├── auth.py          # 认证路由
│   │   ├── token.py         # Token管理路由
│   │   └── image.py         # 图片管理路由
│   ├── services/            # 业务逻辑层
│   │   ├── __init__.py      # 服务导入
│   │   ├── auth.py          # 认证服务
│   │   ├── token.py         # Token服务
│   │   ├── image.py         # 图片服务
│   │   └── gitee.py         # Gitee上传服务
│   ├── utils/               # 工具函数
│   │   ├── __init__.py      # 工具导入
│   │   ├── auth.py          # 认证工具（JWT生成、验证等）
│   │   ├── file.py          # 文件处理（上传、删除、生成文件名等）
│   │   └── gitee.py         # Gitee工具（API调用等）
│   └── static/              # 静态资源存储目录
│       └── {username}/      # 静态资源目录（按用户名分目录）
│           └── images/      # 图片存储目录
├── requirements.txt         # 项目依赖列表
├── .env.example             # 环境变量示例文件
├── README.md                # 项目说明文档
└── test_main.py             # 单元测试文件
```

## 数据库设计

### 1. 用户表 (users)

| 字段名         | 数据类型         | 约束条件            | 描述         |
| ----------- | ------------ | --------------- | ---------- |
| id          | INT          | PRIMARY KEY     | 主键，自增ID    |
| username    | VARCHAR(50)  | UNIQUE NOT NULL | 用户名，唯一     |
| password    | VARCHAR(255) | NOT NULL        | 加密后的密码     |
| email       | VARCHAR(100) | <br />          | 邮箱，**可重复** |
| created\_at | DATETIME     | DEFAULT NOW()   | 创建时间       |
| updated\_at | DATETIME     | DEFAULT NOW()   | 更新时间       |

### 2. Token表 (tokens)

| 字段名         | 数据类型         | 约束条件            | 描述         |
| ----------- | ------------ | --------------- | ---------- |
| id          | INT          | PRIMARY KEY     | 主键，自增ID    |
| user\_id    | INT          | FOREIGN KEY     | 关联用户表ID    |
| name        | VARCHAR(50)  | NOT NULL        | Token名称    |
| token       | VARCHAR(255) | UNIQUE NOT NULL | 加密后的Token值 |
| created\_at | DATETIME     | DEFAULT NOW()   | 创建时间       |

### 3. 图片表 (images)

| 字段名         | 数据类型         | 约束条件          | 描述             |
| ----------- | ------------ | ------------- | -------------- |
| id          | INT          | PRIMARY KEY   | 主键，自增ID        |
| user\_id    | INT          | FOREIGN KEY   | 关联用户表ID        |
| filename    | VARCHAR(255) | NOT NULL      | 原始文件名          |
| nicname     | VARCHAR(255) | NOT NULL      | 生成的唯一名称        |
| path        | VARCHAR(255) | NOT NULL      | 本地存储路径         |
| url         | VARCHAR(255) | NOT NULL      | 直接访问URL        |
| markdown    | VARCHAR(500) | NOT NULL      | Markdown格式地址   |
| html        | VARCHAR(500) | NOT NULL      | HTML格式地址       |
| gitee\_url  | VARCHAR(255) | <br />        | Gitee访问URL（可选） |
| created\_at | DATETIME     | DEFAULT NOW() | 创建时间           |
| updated\_at | DATETIME     | DEFAULT NOW() | 更新时间           |

## API统一管理格式

### 1. 统一响应格式

所有API响应都遵循以下格式：

```json
{
  "code": 0,               // 状态码：0成功，其他为错误码
  "message": "success",    // 状态描述
  "data": {}               // 响应数据，根据接口不同而变化
}
```

### 2. 统一错误处理

| 错误码 | 错误信息                  | 描述              |
| --- | --------------------- | --------------- |
| 400 | Bad Request           | 请求参数错误          |
| 401 | Unauthorized          | 未授权（Token无效或过期） |
| 403 | Forbidden             | 禁止访问（无权限）       |
| 404 | Not Found             | 资源不存在           |
| 500 | Internal Server Error | 服务器内部错误         |

### 3. 统一参数命名

* 分页参数：`page`（页码，默认1）、`page_size`（每页数量，默认20）

* 排序参数：`sort_by`（排序字段）、`order`（排序方式：asc/desc）

* 时间范围：`start_date`（开始时间）、`end_date`（结束时间）

* 模糊查询：`name_like`（名称模糊匹配）

### 4. 统一认证方式

* 使用Bearer Token认证

* Token放在请求头的Authorization字段中：`Authorization: Bearer {token}`

## API设计

### 1. 认证相关API

#### POST /api/auth/register

**功能**：用户注册

**请求体**：

```json
{
  "username": "string",
  "password": "string",
  "email": "string"  // 可选
}
```

**响应**：

```json
{
  "code": 0,
  "message": "success",
  "data": {
    "user": {
      "id": 1,
      "username": "test",
      "email": "test@example.com",
      "created_at": "2023-01-01T00:00:00"
    },
    "access_token": "eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9...",
    "token_type": "bearer"
  }
}
```

#### POST /api/auth/login

**功能**：用户登录

**请求体**：

```json
{
  "username": "string",
  "password": "string"
}
```

**响应**：

```json
{
  "code": 0,
  "message": "success",
  "data": {
    "user": {
      "id": 1,
      "username": "test",
      "email": "test@example.com",
      "created_at": "2023-01-01T00:00:00"
    },
    "access_token": "eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9...",
    "token_type": "bearer"
  }
}
```

### 2. Token管理API

#### GET /api/tokens

**功能**：获取当前用户的Token列表（隐藏实际Token值）

**响应**：

```json
{
  "code": 0,
  "message": "success",
  "data": {
    "tokens": [
      {
        "id": 1,
        "name": "my-token",
        "created_at": "2023-01-01T00:00:00"
      }
    ],
    "total": 1
  }
}
```

#### POST /api/tokens

**功能**：创建新的外部Token（仅创建时返回完整Token）

**请求体**：

```json
{
  "name": "string"  // Token名称
}
```

**响应**：

```json
{
  "code": 0,
  "message": "success",
  "data": {
    "id": 1,
    "name": "my-token",
    "token": "eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9...",  // 仅创建时返回
    "created_at": "2023-01-01T00:00:00"
  }
}
```

#### DELETE /api/tokens/{token\_id}

**功能**：删除指定Token

**响应**：

```json
{
  "code": 0,
  "message": "success",
  "data": {
    "id": 1
  }
}
```

### 3. 图片管理API

#### GET /api/images

**功能**：查询图片列表（支持多条件过滤）

**请求参数**：

* `page`: 页码，默认1

* `page_size`: 每页数量，默认20

* `start_date`: 开始时间，格式：YYYY-MM-DD

* `end_date`: 结束时间，格式：YYYY-MM-DD

* `name_like`: 图片名称模糊匹配

* `sort_by`: 排序字段，默认created\_at

* `order`: 排序方式，默认desc

**响应**：

```json
{
  "code": 0,
  "message": "success",
  "data": {
    "images": [
      {
        "id": 1,
        "filename": "test.jpg",
        "nicname": "test_1234567890_abc123",
        "url": "http://localhost:8000/static/images/1/test_1234567890_abc123.jpg",
        "markdown": "![test.jpg](http://localhost:8000/static/images/1/test_1234567890_abc123.jpg)",
        "html": "<img src=\"http://localhost:8000/static/images/1/test_1234567890_abc123.jpg\" alt=\"test.jpg\">",
        "gitee_url": "https://gitee.com/user/repo/raw/main/images/test_1234567890_abc123.jpg",
        "created_at": "2023-01-01T00:00:00"
      }
    ],
    "total": 1,
    "page": 1,
    "page_size": 20
  }
}
```

#### POST /api/images

**功能**：上传图片（支持批量上传）

**请求体**：FormData格式，多个`file`字段

**响应**：

```json
{
  "code": 0,
  "message": "success",
  "data": {
    "uploaded": 2,
    "failed": 0,
    "images": [
      {
        "id": 1,
        "filename": "test1.jpg",
        "nicname": "test_1234567890_abc123",
        "url": "http://localhost:8000/static/images/1/test_1234567890_abc123.jpg",
        "markdown": "![test1.jpg](http://localhost:8000/static/images/1/test_1234567890_abc123.jpg)",
        "html": "<img src=\"http://localhost:8000/static/images/1/test_1234567890_abc123.jpg\" alt=\"test1.jpg\">",
        "gitee_url": "https://gitee.com/user/repo/raw/main/images/test_1234567890_abc123.jpg",
        "created_at": "2023-01-01T00:00:00"
      },
      {
        "id": 2,
        "filename": "test2.jpg",
        "nicname": "test_1234567891_def456",
        "url": "http://localhost:8000/static/images/1/test_1234567891_def456.jpg",
        "markdown": "![test2.jpg](http://localhost:8000/static/images/1/test_1234567891_def456.jpg)",
        "html": "<img src=\"http://localhost:8000/static/images/1/test_1234567891_def456.jpg\" alt=\"test2.jpg\">",
        "gitee_url": "https://gitee.com/user/repo/raw/main/images/test_1234567891_def456.jpg",
        "created_at": "2023-01-01T00:00:01"
      }
    ]
  }
}
```

#### DELETE /api/images/{image\_id}

**功能**：删除单张图片

**响应**：

```json
{
  "code": 0,
  "message": "success",
  "data": {
    "id": 1
  }
}
```

#### POST /api/images/batch-delete

**功能**：批量删除图片

**请求体**：

```json
{
  "image_ids": [1, 2, 3]
}
```

**响应**：

```json
{
  "code": 0,
  "message": "success",
  "data": {
    "deleted": 3,
    "failed": 0
  }
}
```

## 核心功能实现

### 1. 用户认证

* **JWT Token生成**：使用PyJWT生成Token，过期时间7天

* **密码加密**：使用bcrypt对密码进行哈希处理

* **Token验证**：中间件验证Token的有效性和过期时间

* **用户名唯一**：确保用户名不重复

* **邮箱可重复**：允许不同用户使用相同邮箱

### 2. Token管理

* **外部Token生成**：生成永不过期的外部Token，用于外部API调用

* **Token存储**：将加密后的Token存储到数据库

* **Token安全**：仅在创建时返回完整Token，后续查询仅返回基本信息

* **Token验证**：验证外部Token的有效性

### 3. 图片管理

* **文件存储**：按用户名分目录存储图片，目录结构：`static/{username}/images/`，避免不同用户图片混淆

* **nicname生成**：格式：`{username}_{timestamp}_{random_str}`，确保唯一性

* **图片地址生成**：自动生成url、markdown和html格式的地址

* **批量操作**：支持批量上传和删除图片

* **多条件查询**：支持按时间范围、名称模糊查询图片

* **同步删除**：删除图片时，同时删除数据库记录和静态资源文件

### 4. Gitee上传功能

* **配置管理**：通过环境变量配置Gitee仓库信息

* **自动上传**：图片上传后自动同步到Gitee仓库

* **错误处理**：Gitee上传失败时，记录日志并继续执行

* **Gitee API调用**：使用gidgethub库调用Gitee API

## 安全措施

1. **密码安全**：使用bcrypt进行密码哈希，加盐处理
2. **Token安全**：

   * JWT Token使用强密钥签名

   * Token过期时间设置为7天

   * 外部Token永不过期，但可随时删除

   * Token传输使用HTTPS
3. **权限控制**：

   * 每个用户只能访问和操作自己的图片

   * 每个用户只能管理自己的Token
4. **输入验证**：

   * 使用Pydantic进行请求数据验证

   * 限制上传文件类型和大小

   * 防止SQL注入和XSS攻击
5. **CORS配置**：允许前端域名跨域访问
6. **日志记录**：记录关键操作和错误信息

## 环境变量配置

```env
# 数据库配置
DATABASE_URL=mysql+pymysql://root:123456@localhost:3306/imagebed

# Redis配置
REDIS_URL=redis://localhost:6379/0

# JWT配置
JWT_SECRET_KEY=your-strong-secret-key
JWT_ACCESS_TOKEN_EXPIRE_DAYS=7

# Gitee配置（可选）
GITEE_ACCESS_TOKEN=your-gitee-access-token
GITEE_REPO_OWNER=your-gitee-username
GITEE_REPO_NAME=your-gitee-repo-name
GITEE_REPO_BRANCH=main

# 项目配置
BASE_URL=http://localhost:8000
UPLOAD_FOLDER=static/images
MAX_FILE_SIZE=10485760  # 10MB
ALLOWED_FILE_TYPES=jpg,jpeg,png,gif,webp
```

## 开发步骤

1. **项目初始化**：

   * 创建项目目录结构

   * 安装依赖包

   * 配置环境变量

2. **数据库设计与实现**：

   * 创建数据库和表

   * 实现SQLAlchemy模型

   * 编写数据库连接代码

3. **认证系统实现**：

   * 实现用户注册和登录功能

   * 实现JWT Token生成和验证

   * 编写认证中间件

4. **Token管理实现**：

   * 实现Token创建、查询和删除功能

   * 实现Token验证逻辑

5. **图片管理实现**：

   * 实现图片上传功能（支持批量）

   * 实现图片查询功能（支持多条件）

   * 实现图片删除功能（单张和批量）

   * 实现图片地址生成逻辑

6. **Gitee上传实现**：

   * 实现Gitee API调用

   * 实现图片同步上传到Gitee

   * 添加错误处理和日志记录

7. **API文档生成**：

   * 使用FastAPI自动生成Swagger UI文档

   * 使用ReDoc生成API文档

8. **单元测试**：

   * 编写认证功能测试

   * 编写Token管理测试

   * 编写图片管理测试

   * 编写Gitee上传测试

9. **部署与优化**：

   * 配置生产环境

   * 优化数据库查询

   * 配置Nginx反向代理

   * 配置HTTPS

## API文档

* **Swagger UI**: <http://localhost:8000/docs>

* **ReDoc**: <http://localhost:8000/redoc>

## 测试策略

1. **单元测试**：测试每个功能模块的正确性
2. **集成测试**：测试模块之间的交互
3. **接口测试**：测试API的正确性和性能
4. **安全测试**：测试认证、授权和输入验证
5. **性能测试**：测试系统在高并发下的表现

## 部署方案

### 开发环境

```bash
# 安装依赖
pip install -r requirements.txt

# 运行应用
uvicorn src.main:app --reload --host 0.0.0.0 --port 8000
```

### 生产环境

1. 使用Gunicorn作为WSGI服务器
2. 使用Nginx作为反向代理
3. 配置HTTPS
4. 使用Supervisor管理进程
5. 配置日志轮转

## 维护与扩展

1. **日志管理**：定期查看和分析日志
2. **数据库备份**：定期备份数据库
3. **安全更新**：及时更新依赖包，修复安全漏洞
4. **功能扩展**：

   * 支持更多图片格式

   * 支持图片压缩和水印

   * 支持图片预览和编辑

   * 支持更多云存储服务

## 预期成果

1. 完整的前后端分离图床后端系统
2. 统一格式的RESTful API
3. 自动生成的API文档
4. 完整的单元测试
5. 部署方案和维护文档

## 风险与应对

1. **数据库连接问题**：使用连接池管理数据库连接，设置超时时间
2. **文件上传失败**：添加重试机制，记录失败日志
3. **Gitee API限流**：添加请求队列，控制API调用频率
4. **高并发访问**：使用Redis缓存热点数据，优化数据库查询
5. **安全漏洞**：定期进行安全审计，及时更新依赖包

***

本计划详细描述了前后端分离图床后端的开发方案，包括目录结构、数据库设计、API设计、核心功能实现、技术栈、安全措施、开发步骤等。该计划遵循了API统一管理格式的要求，确保了系统的安全性、可靠性和可扩展性。
